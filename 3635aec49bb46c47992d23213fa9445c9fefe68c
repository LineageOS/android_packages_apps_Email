{
  "comments": [
    {
      "key": {
        "uuid": "3a461143_ef13dd0b",
        "filename": "provider_src/com/android/email/mail/store/ImapFolder.java",
        "patchSetId": 3
      },
      "lineNbr": 397,
      "author": {
        "id": 3134
      },
      "writtenOn": "2015-06-13T23:14:49Z",
      "side": 1,
      "message": "Only call to only one of these two. If the connection is closed, then we shouldn\u0027t return it to the pool. Both destroy the imap response, so probably connection.close(); is the one that we want to use here.",
      "revId": "3635aec49bb46c47992d23213fa9445c9fefe68c",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3a461143_4fadd187",
        "filename": "provider_src/com/android/email/mail/store/ImapFolder.java",
        "patchSetId": 3
      },
      "lineNbr": 397,
      "author": {
        "id": 1063
      },
      "writtenOn": "2015-06-14T00:49:22Z",
      "side": 1,
      "message": "We definitely need connection.close() because it\u0027s what makes the thread exit if the server doesn\u0027t respond. Why shouldn\u0027t we pool closed connections? AFAICT they\u0027re closed anyway on unpooling, or am I missing something?",
      "parentUuid": "3a461143_ef13dd0b",
      "revId": "3635aec49bb46c47992d23213fa9445c9fefe68c",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3a461143_8f033976",
        "filename": "provider_src/com/android/email/mail/store/ImapFolder.java",
        "patchSetId": 3
      },
      "lineNbr": 397,
      "author": {
        "id": 3134
      },
      "writtenOn": "2015-06-14T03:12:05Z",
      "side": 1,
      "message": "No, the connection isn\u0027t close when it is returned to the pool. It\u0027s recycled when the ImapStore is destroyed. IHMO, isn\u0027t useful to return closed connections to a pool of open connections. In that pool we want connections that we want to use later (a closed connection means we have to discard it and reopened again, so there is no gain in returned to the pool).",
      "parentUuid": "3a461143_4fadd187",
      "revId": "3635aec49bb46c47992d23213fa9445c9fefe68c",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3a461143_ef103dab",
        "filename": "provider_src/com/android/email/mail/store/ImapFolder.java",
        "patchSetId": 3
      },
      "lineNbr": 397,
      "author": {
        "id": 1063
      },
      "writtenOn": "2015-06-14T05:09:37Z",
      "side": 1,
      "message": "I thought it\u0027s closed when pulling it out of the pool again, see here: https://github.com/CyanogenMod/android_packages_apps_Email/blob/cm-12.1/provider_src/com/android/email/mail/store/ImapStore.java#L575\n\nAm I misinterpreting this code?",
      "parentUuid": "3a461143_8f033976",
      "revId": "3635aec49bb46c47992d23213fa9445c9fefe68c",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3a461143_0ff909c9",
        "filename": "provider_src/com/android/email/mail/store/ImapFolder.java",
        "patchSetId": 3
      },
      "lineNbr": 399,
      "author": {
        "id": 3134
      },
      "writtenOn": "2015-06-13T23:14:49Z",
      "side": 1,
      "message": "This is a bit risky. connection.close(); doesn\u0027t expect to launch any exception to wait for the reader to exit could lead to dead lock, isn\u0027t?",
      "revId": "3635aec49bb46c47992d23213fa9445c9fefe68c",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3a461143_6faa8d72",
        "filename": "provider_src/com/android/email/mail/store/ImapFolder.java",
        "patchSetId": 3
      },
      "lineNbr": 399,
      "author": {
        "id": 1063
      },
      "writtenOn": "2015-06-14T00:49:22Z",
      "side": 1,
      "message": "What do you mean exactly? Do you mean that the thread might not exit? If so, why? The read code properly should deal with a closed stream and exit.",
      "parentUuid": "3a461143_0ff909c9",
      "revId": "3635aec49bb46c47992d23213fa9445c9fefe68c",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3a461143_af08f592",
        "filename": "provider_src/com/android/email/mail/store/ImapFolder.java",
        "patchSetId": 3
      },
      "lineNbr": 399,
      "author": {
        "id": 3134
      },
      "writtenOn": "2015-06-14T03:12:05Z",
      "side": 1,
      "message": "Is there any possibility that we doesn\u0027t exit from this join? All the IOExceptions are capture inside the transport, so could this lead to not exit from the thread? Also, closing the connection will run this code:\n\n  destroyResponses();\n  mParser \u003d null;\n  mImapStore \u003d null;\n\nMany things can happens from here, I\u0027m not sure we control all of them.",
      "parentUuid": "3a461143_6faa8d72",
      "revId": "3635aec49bb46c47992d23213fa9445c9fefe68c",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "3a461143_0f266916",
        "filename": "provider_src/com/android/email/mail/store/ImapFolder.java",
        "patchSetId": 3
      },
      "lineNbr": 399,
      "author": {
        "id": 1063
      },
      "writtenOn": "2015-06-14T05:09:37Z",
      "side": 1,
      "message": "I\u0027ve verified that closing the connection causes the exception callback in the idle reader to be called. The exception is generated via [1] in that case and propagates up.\n\nmParser and mImapStore being reset indeed can cause issues and in fact _do_ cause issues: The NPE mentioned earlier is thrown from [2] I think. We\u0027ll probably need to fix those cases (for the NPE it\u0027s easy: just save mParser to a local variable); as mentioned earlier I see no other way out of the pending read than closing the connection\u0027s input and output streams. If you have any better idea I\u0027m all ears :)\n\n[1] https://github.com/CyanogenMod/android_packages_apps_Email/blob/cm-12.1/provider_src/com/android/email/mail/store/imap/ImapResponseParser.java#L124\n[2] https://github.com/CyanogenMod/android_packages_apps_Email/blob/cm-12.1/provider_src/com/android/email/mail/store/ImapConnection.java#L421",
      "parentUuid": "3a461143_af08f592",
      "revId": "3635aec49bb46c47992d23213fa9445c9fefe68c",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    }
  ]
}